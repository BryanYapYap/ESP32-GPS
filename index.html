<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Real-Time Tracker with Routing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    body, html { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }
    .leaflet-control-layers-toggle { background-image: url(https://leafletjs.com/examples/custom-icons/leaf-green.png); }
    .control-button {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 999;
      background: white;
      border-radius: 5px;
      padding: 5px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
const BIN_ID = "685bcd5b8960c979a5b10ee3";
const ACCESS_KEY = "$2a$10$ILjBbVQboACduWRv7UGvj.tukJnCdHhlhg3kAi.e.S3NeCZCTb5/6";
let currentMarker, routeControl, currentPos;

const map = L.map('map').setView([3.8, 103.3], 15);
const baseLayers = {
  "Normal": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map),
  "Satellite": L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap HOT'
  })
};
L.control.layers(baseLayers).addTo(map);

// 目的地选择
let destinationMarker = null;
map.on('click', function(e) {
  if (destinationMarker) map.removeLayer(destinationMarker);
  destinationMarker = L.marker(e.latlng).addTo(map).bindPopup("目的地").openPopup();
  if (routeControl) map.removeControl(routeControl);
  if (!currentPos) return;
  routeControl = L.Routing.control({
    waypoints: [
      L.latLng(currentPos[0], currentPos[1]),
      L.latLng(e.latlng.lat, e.latlng.lng)
    ],
    routeWhileDragging: false
  }).addTo(map);
});

// 实时获取定位数据
async function updateLocation() {
  try {
    const res = await axios.get(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
      headers: {
        'X-Access-Key': ACCESS_KEY
      }
    });
    const { lat, lng } = res.data.record;
    currentPos = [lat, lng];
    if (currentMarker) {
      currentMarker.setLatLng(currentPos);
    } else {
      currentMarker = L.marker(currentPos).addTo(map).bindPopup("当前位置").openPopup();
      map.setView(currentPos, 18);
    }
  } catch (err) {
    console.error("获取定位失败：", err);
  }
}

setInterval(updateLocation, 5000);
</script>
</body>
</html>
