<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ESP32 Real-time GPS Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    #dashboard {
      width: 220px;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 10px;
      position: fixed;
      bottom: 10px;
      right: 10px;
      z-index: 9999;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      font-size: 13px;
    }
    #dashboard h2 {
      font-size: 16px;
      margin-bottom: 8px;
    }
    #dashboard p {
      margin: 3px 0;
      font-size: 13px;
    }
    .btn {
      padding: 6px 8px;
      font-size: 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: white;
      margin-top: 6px;
    }
    .btn.drive { background-color: #28a745; }
    .btn.street { background-color: #007bff; }
    .btn:hover { opacity: 0.9; }
    .viewer {
      font-size: 12px;
      margin-top: 8px;
    }
    .viewer ul {
      margin: 4px 0;
      padding-left: 15px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="dashboard">
    <h2>üì° People Tracker</h2>
    <p><strong>Device:</strong> SafetyDevice-01</p>
    <p><strong>Status:</strong> ‚úÖ Normal</p>
    <p><strong>Battery:</strong> 90%</p>
    <p><strong>Lat:</strong> 3.83099</p>
    <p><strong>Lng:</strong> 103.32606</p>
    <button class="btn drive" onclick="goToGMaps()">üöó Drive</button>
    <button class="btn street" onclick="goToStreetView()">üèôÔ∏è Street</button>

    <div class="viewer">
      <strong>üëÅÔ∏è Currently Viewing</strong>
      <ul id="viewerList"><li>Loading...</li></ul>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const lat = 3.83099;
    const lng = 103.32606;
    const map = L.map('map').setView([lat, lng], 17);

    const normal = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    const satellite = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}');
    const hybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}');
    hybrid.addTo(map);
    L.control.layers({ "Normal": normal, "Satellite": satellite, "Hybrid": hybrid }).addTo(map);

    let marker = L.marker([lat, lng]).addTo(map).bindPopup("üìç ESP32").openPopup();

    function goToGMaps() {
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, "_blank");
    }
    function goToStreetView() {
      window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`, "_blank");
    }

    // === ËÆøÈóÆËÄÖËÆ∞ÂΩïÈÄªËæëÔºàJSONBinÔºâ ===
    const binId = "685bcd5b8960c979a5b10ee3";
    const masterKey = "$2a$10$pXDgVY8ppAPPg1MRP5lCM.kO.UD505/0F5IEwNmoRuqhrRiLQbxDm";
    const jsonBinUrl = `https://api.jsonbin.io/v3/b/${binId}`;

    const deviceName = navigator.userAgent.includes("iPhone") ? "üì± iPhone"
                      : navigator.userAgent.includes("Android") ? "ü§ñ Android"
                      : navigator.userAgent.includes("Windows") ? "üñ•Ô∏è Windows"
                      : navigator.userAgent.includes("Macintosh") ? "üíª Mac"
                      : "üìü Unknown";

    const timeNow = new Date().toLocaleTimeString('en-GB');

    fetch(jsonBinUrl, { headers: { "X-Master-Key": masterKey } })
      .then(res => res.json())
      .then(json => {
        let data = json.record || {};
        let visitors = data.visitors || [];

        // ÁßªÈô§ÊóßËÆæÂ§áÔºåÊ∑ªÂä†ÂΩìÂâçËÆæÂ§á
        visitors = visitors.filter(v => v.device !== deviceName);
        visitors.push({ device: deviceName, time: timeNow });
        if (visitors.length > 10) visitors.shift(); // ‰øùÁïôÊúÄËøë10‰∏™

        // ÂÜôÂÖ•Êõ¥Êñ∞ÂêéÁöÑÊï∞ÊçÆ
        fetch(jsonBinUrl, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Master-Key": masterKey
          },
          body: JSON.stringify({ ...data, visitors })
        });

        // ÊòæÁ§∫ËÆøÂÆ¢
        const viewerList = document.getElementById("viewerList");
        viewerList.innerHTML = visitors.map(v => `<li>${v.device} <small>(${v.time})</small></li>`).join("");
      });
  </script>
</body>
</html>
